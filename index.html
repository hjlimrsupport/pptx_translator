<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office AI Suite - Translate & Style</title>
    <link rel="icon"
        href="https://raw.githubusercontent.com/google/material-design-icons/master/src/action/translate/materialicons/24px.svg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --secondary: #0ea5e9;
            --bg-body: #f1f5f9;
            --bg-container: #ffffff;
            --text-main: #1e293b;
            --text-dim: #64748b;
            --border: #e2e8f0;
            --accent: #f59e0b;
            --glass: rgba(255, 255, 255, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
        }

        body {
            background-color: var(--bg-body);
            background-image:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.05) 0, transparent 50%),
                radial-gradient(at 100% 100%, rgba(14, 165, 233, 0.05) 0, transparent 50%);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: var(--bg-container);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        /* Mode Switcher */
        .mode-switcher {
            display: flex;
            background: #f8fafc;
            padding: 6px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border-radius: 12px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            background: #eef2ff;
            color: var(--primary);
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 15px;
            border: 1px solid #e0e7ff;
        }

        h1 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 10px;
            letter-spacing: -0.025em;
            color: var(--text-main);
        }

        .subtitle {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 24px;
            text-align: left;
        }

        .form-group.hidden {
            display: none;
        }

        label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.05em;
        }

        .drop-zone {
            display: block;
            width: 100%;
            background: #f8fafc;
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: var(--primary);
            background: #f5f3ff;
        }

        .upload-icon {
            width: 40px;
            height: 40px;
            color: var(--text-dim);
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .drop-zone:hover .upload-icon {
            color: var(--primary);
            transform: translateY(-3px);
        }

        input[type="password"],
        select {
            width: 100%;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-main);
            padding: 12px 16px;
            outline: none;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        input[type="password"]:focus,
        select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn-main {
            width: 100%;
            padding: 16px;
            margin-top: 10px;
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--primary);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-main:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.2);
        }

        .btn-main:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        #status {
            margin-top: 25px;
            padding: 15px;
            background: #f1f5f9;
            border-radius: 12px;
            font-size: 0.85rem;
            min-height: 100px;
            max-height: 180px;
            overflow-y: auto;
            color: var(--text-main);
            border-left: 4px solid var(--primary);
            white-space: pre-wrap;
            text-align: left;
            line-height: 1.6;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--primary);
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .footer {
            margin-top: 30px;
            font-size: 0.75rem;
            color: var(--text-dim);
            line-height: 1.6;
        }

        .security-notice {
            margin-top: 20px;
            font-size: 0.7rem;
            color: #94a3b8;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        /* Image Review */
        #imageReviewSection {
            margin-top: 25px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 16px;
            border: 1px solid var(--border);
            text-align: left;
            display: none;
        }

        #imageReviewSection h3 {
            font-size: 0.9rem;
            margin-bottom: 12px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .slide-group {
            margin-bottom: 20px;
        }

        .slide-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 4px;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .image-card {
            position: relative;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16 / 10;
            border: 2px solid var(--border);
            transition: all 0.2s ease;
        }

        .image-card img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #fff;
        }

        .image-card.selected {
            border-color: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.2);
        }

        .checkbox-container {
            position: absolute;
            top: 6px;
            right: 6px;
            z-index: 2;
        }

        .image-card input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #ef4444;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="mode-switcher">
            <button class="mode-btn active" id="modeAi">AI Translation & Style</button>
            <button class="mode-btn" id="modeStyle">Style Only (Fast)</button>
        </div>

        <div class="badge" id="appBadge">Office AI Suite v2.5</div>
        <h1 id="appTitle">Office Translator</h1>
        <p class="subtitle" id="appSubtitle"></p>

        <div class="form-group">
            <label id="lblDrop">1. ë¬¸ì„œ íŒŒì¼ ì„ íƒ (.pptx, .docx)</label>
            <label for="fileInput" class="drop-zone" id="dropZone">
                <div class="drop-zone-content">
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M12 16V8M12 8L9 11M12 8L15 11M7.8 20H16.2C17.8802 20 18.7202 20 19.362 19.673C19.9265 19.3854 20.3854 18.9265 20.673 18.362C21 17.7202 21 16.8802 21 15.2V8.8C21 7.11984 21 6.27976 20.673 5.63803C20.3854 5.07354 19.9265 4.6146 19.362 4.32698C18.7202 4 17.8802 4 16.2 4H7.8C6.11984 4 5.27976 4 4.63803 4.32698C4.07354 4.6146 3.6146 5.07354 3.32698 5.63803C3 6.27976 3 7.11984 3 8.8V15.2C3 16.8802 3 17.7202 3.32698 18.362C3.6146 18.9265 4.07354 19.3854 4.63803 19.673C5.27976 20 6.11984 20 7.8 20Z"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p id="fileNameDisplay"></p>
                </div>
                <input type="file" id="fileInput" accept=".pptx,.docx" style="display: none;">
            </label>
        </div>

        <div id="aiOptions">
            <div class="form-group">
                <label id="lblDirection">2. ë²ˆì—­ ë°©í–¥</label>
                <select id="direction">
                    <option value="ko-ja">í•œêµ­ì–´ â†’ ì¼ë³¸ì–´</option>
                    <option value="ja-ko">ì¼ë³¸ì–´ â†’ í•œêµ­ì–´</option>
                </select>
            </div>

            <div class="form-group">
                <label id="lblApiKey">3. Gemini API Key(s)</label>
                <input type="password" id="apiKey" placeholder="">
            </div>
        </div>

        <div id="imageReviewSection">
            <h3 id="lblImageReview">êµì²´ í•„ìš” ì´ë¯¸ì§€ ì„ íƒ</h3>
            <div id="imageReviewGrid"></div>
        </div>

        <button id="mainBtn" class="btn-main"></button>

        <div class="progress-bar-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="status"></div>

        <div class="footer">
            Powered by JSZip & Google Gemini API â€¢ 100% Client-side Processing
            <div class="security-notice" id="securityNotice"></div>
        </div>
    </div>

    <script>
        const LANG_DATA = {
            ko: {
                title_ai: "Office Translator",
                title_style: "Font Stylist",
                subtitle_ai: "",
                subtitle_style: "ë¬¸ì„œì˜ ëª¨ë“  í°íŠ¸ë¥¼ <b>Meiryo</b>ë¡œ ì¦‰ì‹œ í†µí•©í•©ë‹ˆë‹¤.",
                lblDrop: "1. ë¬¸ì„œ íŒŒì¼ ì„ íƒ (.pptx, .docx)",
                dropHelp: "<b>í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</b> ë˜ëŠ” ì—¬ê¸°ì— ë“œë˜ê·¸",
                lblDirection: "2. ë²ˆì—­ ë°©í–¥",
                lblApiKey: "3. Gemini API Key(s)",
                apiKeyPlaceholder: "Gemini API í‚¤ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”",
                lblImageReview: "êµì²´ í•„ìš” ì´ë¯¸ì§€ ì„ íƒ (ë²ˆì—­ ì‹œ ìë™ í‘œì‹œ)",
                mainBtn_ai: "ì‘ì—… ì‹œì‘ ë° ë‹¤ìš´ë¡œë“œ",
                mainBtn_style: "í°íŠ¸ íŒ¨ì¹˜ ì‹œì‘",
                status_ready: "íŒŒì¼ì„ ì„ íƒí•˜ê³  ì¤€ë¹„í•´ì£¼ì„¸ìš”.",
                securityNotice: "ğŸ›¡ï¸ ì •ë³´ë³´í˜¸ ì•ˆë‚´: ë³¸ ë„êµ¬ëŠ” ë¬¸ì„œë¥¼ ì„œë²„ë¡œ ì „ì†¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëª¨ë“  ì‘ì—…ì€ ë¸Œë¼ìš°ì € ë‚´ ë©”ëª¨ë¦¬ì—ì„œ ì²˜ë¦¬ë˜ë©°, ì˜¤ì§ ë²ˆì—­ì— í•„ìš”í•œ ë¬¸ìì—´ë§Œ ì•”í˜¸í™”ëœ APIë¥¼ í†µí•´ ì „ì†¡ë©ë‹ˆë‹¤.",
                log_mode_ai: "AI ë²ˆì—­ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.",
                log_mode_style: "í°íŠ¸ ìŠ¤íƒ€ì¼ëŸ¬ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.",
                log_zip_ready: "íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ: ",
                log_extract_img: "ì´ë¯¸ì§€ ì¶”ì¶œ ì¤‘...",
                log_extract_done: "ì´ë¯¸ì§€ ì¶”ì¶œ ì™„ë£Œ.",
                log_start: "ì‘ì—… ì‹œì‘...",
                file_selected: " ì„ íƒë¨ (ë³€ê²½ í´ë¦­)"
            },
            ja: {
                title_ai: "Office Translator",
                title_style: "Font Stylist",
                subtitle_ai: "",
                subtitle_style: "æ–‡æ›¸ã®ã™ã¹ã¦ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’<b>Meiryo</b>ã«å³åº§ã«çµ±åˆã—ã¾ã™ã€‚",
                lblDrop: "1. æ–‡æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ (.pptx, .docx)",
                dropHelp: "<b>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</b> ã¾ãŸã¯ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°",
                lblDirection: "2. ç¿»è¨³æ–¹å‘",
                lblApiKey: "3. Gemini APIã‚­ãƒ¼",
                apiKeyPlaceholder: "Gemini APIã‚­ãƒ¼ã‚’ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„",
                lblImageReview: "äº¤æ›ãŒå¿…è¦ãªç”»åƒã‚’é¸æŠ (è‡ªå‹•è¡¨ç¤º)",
                mainBtn_ai: "å®Ÿè¡ŒãŠã‚ˆã³ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                mainBtn_style: "ãƒ•ã‚©ãƒ³ãƒˆä¿®æ­£ã‚’é–‹å§‹",
                status_ready: "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦æº–å‚™ã—ã¦ãã ã•ã„ã€‚",
                securityNotice: "ğŸ›¡ï¸ æƒ…å ±ä¿è­·æ¡ˆå†…: æœ¬ãƒ„ãƒ¼ãƒ«ã¯æ–‡æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã¾ã›ã‚“ã€‚ã™ã¹ã¦ã®å‡¦ç†ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§è¡Œã‚ã‚Œã€ç¿»è¨³ã«å¿…è¦ãªæ–‡å­—åˆ—ã®ã¿ãŒæš—í˜¸åŒ–ã•ã‚Œã¦APIã¸é€ä¿¡ã•ã‚Œã¾ã™ã€‚",
                log_mode_ai: "AIç¿»è¨³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã—ãŸã€‚",
                log_mode_style: "ãƒ•ã‚©ãƒ³ãƒˆä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã—ãŸã€‚",
                log_zip_ready: "ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™å®Œäº†: ",
                log_extract_img: "ç”»åƒã‚’æŠ½å‡ºä¸­...",
                log_extract_done: "ç”»åƒæŠ½å‡ºå®Œäº†ã€‚",
                log_start: "å®Ÿè¡Œä¸­...",
                file_selected: " é¸æŠæ¸ˆã¿ (å¤‰æ›´)"
            }
        };

        const currentLang = (navigator.language || navigator.userLanguage).startsWith('ja') ? 'ja' : 'ko';
        const t = LANG_DATA[currentLang];

        let currentMode = 'ai';

        const ui = {
            modeAi: document.getElementById('modeAi'),
            modeStyle: document.getElementById('modeStyle'),
            appTitle: document.getElementById('appTitle'),
            appSubtitle: document.getElementById('appSubtitle'),
            aiOptions: document.getElementById('aiOptions'),
            mainBtn: document.getElementById('mainBtn'),
            fileInput: document.getElementById('fileInput'),
            dropZone: document.getElementById('dropZone'),
            fileNameDisplay: document.getElementById('fileNameDisplay'),
            status: document.getElementById('status'),
            progressBar: document.getElementById('progressBar'),
            direction: document.getElementById('direction'),
            apiKey: document.getElementById('apiKey'),
            imageReviewSection: document.getElementById('imageReviewSection'),
            imageReviewGrid: document.getElementById('imageReviewGrid'),
            lblDrop: document.getElementById('lblDrop'),
            lblDirection: document.getElementById('lblDirection'),
            lblApiKey: document.getElementById('lblApiKey'),
            lblImageReview: document.getElementById('lblImageReview'),
            securityNotice: document.getElementById('securityNotice')
        };

        // Initialize UI with language
        function initLang() {
            ui.modeAi.textContent = currentLang === 'ko' ? "AI Translation & Style" : "AIç¿»è¨³ & ã‚¹ã‚¿ã‚¤ãƒ«";
            ui.modeStyle.textContent = currentLang === 'ko' ? "Style Only (Fast)" : "ã‚¹ã‚¿ã‚¤ãƒ«ã®ã¿ (é«˜é€Ÿ)";
            ui.lblDrop.textContent = t.lblDrop;
            ui.fileNameDisplay.innerHTML = t.dropHelp;
            ui.lblDirection.textContent = t.lblDirection;
            ui.lblApiKey.textContent = t.lblApiKey;
            ui.apiKey.placeholder = t.apiKeyPlaceholder;
            ui.lblImageReview.textContent = t.lblImageReview;
            ui.status.textContent = t.status_ready;
            ui.securityNotice.textContent = t.securityNotice;
            setMode('ai');
        }

        function setMode(mode) {
            currentMode = mode;
            if (mode === 'ai') {
                ui.modeAi.classList.add('active');
                ui.modeStyle.classList.remove('active');
                ui.aiOptions.classList.remove('hidden');
                ui.appTitle.textContent = t.title_ai;
                ui.appSubtitle.innerHTML = t.subtitle_ai;
                ui.mainBtn.textContent = t.mainBtn_ai;
                log(t.log_mode_ai);
            } else {
                ui.modeStyle.classList.add('active');
                ui.modeAi.classList.remove('active');
                ui.aiOptions.classList.add('hidden');
                ui.appTitle.textContent = t.title_style;
                ui.appSubtitle.innerHTML = t.subtitle_style;
                ui.mainBtn.textContent = t.mainBtn_style;
                log(t.log_mode_style);
            }
        }

        ui.modeAi.addEventListener('click', () => setMode('ai'));
        ui.modeStyle.addEventListener('click', () => setMode('style'));

        const CONFIG = {
            pptx: {
                getFiles: (zip) => Object.keys(zip.files).filter(n =>
                    (n.startsWith("ppt/slides/slide") ||
                        n.startsWith("ppt/slideMasters/slideMaster") ||
                        n.startsWith("ppt/slideLayouts/slideLayout") ||
                        n.startsWith("ppt/notesSlides/notesSlide")) && n.endsWith(".xml")
                ),
                ns: "http://schemas.openxmlformats.org/drawingml/2006/main",
                pTag: "p", tTag: "t", rPrTag: "rPr",
                fontTags: ["latin", "ea", "cs"], isWord: false
            },
            docx: {
                getFiles: (zip) => Object.keys(zip.files).filter(n => n === "word/document.xml" || n.startsWith("word/header") || n.startsWith("word/footer")),
                ns: "http://schemas.openxmlformats.org/wordprocessingml/2006/main",
                pTag: "p", tTag: "t", rPrTag: "rPr",
                fontTags: ["ascii", "hAnsi", "eastAsia", "cs"], isWord: true
            }
        };

        let selectedImages = {};

        ['dragenter', 'dragover'].forEach(e => ui.dropZone.addEventListener(e, (ev) => { ev.preventDefault(); ui.dropZone.classList.add('drag-over'); }));
        ['dragleave', 'drop'].forEach(e => ui.dropZone.addEventListener(e, (ev) => { ev.preventDefault(); ui.dropZone.classList.remove('drag-over'); }));
        ui.dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) { ui.fileInput.files = files; updateFileUI(files[0]); }
        });
        ui.fileInput.addEventListener('change', (e) => { if (e.target.files[0]) updateFileUI(e.target.files[0]); });

        function updateFileUI(file) {
            ui.fileNameDisplay.innerHTML = `<b>${file.name}</b> ${t.file_selected}`;
            log(`${t.log_zip_ready}${file.name}`);
            const ext = file.name.split('.').pop().toLowerCase();
            if (ext === 'pptx') extractImages(file);
            else { ui.imageReviewSection.style.display = 'none'; selectedImages = {}; }
        }

        function resolveZipPath(basePath, relativePath) {
            const stack = basePath.split("/"); stack.pop();
            const parts = relativePath.split("/");
            for (const part of parts) {
                if (part === "..") stack.pop();
                else if (part !== ".") stack.push(part);
            }
            return stack.join("/");
        }

        async function extractImages(file) {
            try {
                const zip = await JSZip.loadAsync(file);
                const slides = Object.keys(zip.files).filter(n => n.startsWith("ppt/slides/slide") && n.endsWith(".xml"));
                ui.imageReviewGrid.innerHTML = "";
                selectedImages = {};
                if (slides.length === 0) { ui.imageReviewSection.style.display = 'none'; return; }
                ui.imageReviewSection.style.display = 'block';
                log(t.log_extract_img);
                for (let i = 0; i < slides.length; i++) {
                    const slidePath = slides[i];
                    const slideNum = slidePath.match(/slide(\d+)\.xml/)[1];
                    const relsPath = `ppt/slides/_rels/slide${slideNum}.xml.rels`;
                    if (!zip.files[relsPath]) continue;
                    const relsXml = await zip.file(relsPath).async("string");
                    const relsDoc = new DOMParser().parseFromString(relsXml, "application/xml");
                    const rels = Array.from(relsDoc.getElementsByTagName("Relationship")).filter(r => r.getAttribute("Type").includes("image"));
                    if (rels.length === 0) continue;
                    const slideGroup = document.createElement('div');
                    slideGroup.className = 'slide-group';
                    slideGroup.innerHTML = `<div class="slide-title">Slide ${slideNum}</div>`;
                    const grid = document.createElement('div');
                    grid.className = 'image-grid';
                    for (const rel of rels) {
                        const rId = rel.getAttribute("Id");
                        const target = resolveZipPath(slidePath, rel.getAttribute("Target"));
                        const imgFile = zip.file(target);
                        if (!imgFile) continue;
                        const ext = target.split('.').pop().toLowerCase();
                        const isUnsupported = ['emf', 'wmf', 'tiff', 'tif'].includes(ext);
                        const blob = await imgFile.async("blob");
                        const url = URL.createObjectURL(blob);
                        const card = document.createElement('div');
                        card.className = 'image-card';
                        card.innerHTML = `<div class="checkbox-container"><input type="checkbox" data-slide="${slideNum}" data-rid="${rId}"></div>
                            <img src="${isUnsupported ? '' : url}" onerror="this.style.display='none'; this.parentElement.innerHTML+='<div style=\\'padding:20px; font-size:10px; color:#64748b; text-align:center;\\'>N/A (${ext})</div>'">`;
                        card.addEventListener('click', (e) => {
                            if (e.target.tagName !== 'INPUT') {
                                const cb = card.querySelector('input');
                                cb.checked = !cb.checked; cb.dispatchEvent(new Event('change'));
                            }
                        });
                        const cb = card.querySelector('input');
                        cb.addEventListener('change', (e) => {
                            if (!selectedImages[slideNum]) selectedImages[slideNum] = {};
                            selectedImages[slideNum][rId] = e.target.checked;
                            card.classList.toggle('selected', e.target.checked);
                        });
                        grid.appendChild(card);
                    }
                    slideGroup.appendChild(grid);
                    ui.imageReviewGrid.appendChild(slideGroup);
                }
                log(t.log_extract_done);
            } catch (e) { log(`Error: ${e.message}`); }
        }

        function log(msg, replace = false) {
            if (replace) ui.status.innerHTML = `<div>${msg}</div>`;
            else ui.status.innerHTML += `<div>> ${msg}</div>`;
            ui.status.scrollTop = ui.status.scrollHeight;
        }
        function setProgress(p) { ui.progressBar.style.width = p + '%'; }

        async function getModels(key) {
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                if (!r.ok) return ['gemini-2.0-flash', 'gemini-1.5-flash'];
                const data = await r.json();
                const valid = data.models.filter(m => m.supportedGenerationMethods.includes('generateContent') && !m.name.includes('-exp')).map(m => m.name.replace('models/', ''));
                const prio = ['gemini-2.0-flash', 'gemini-2.5-flash', 'gemini-1.5-flash', 'gemini-pro'];
                const res = prio.filter(p => valid.some(v => v.includes(p)));
                return res.length > 0 ? res : ['gemini-1.5-flash'];
            } catch (e) { return ['gemini-1.5-flash']; }
        }

        async function translateBatch(texts, keysRaw, retryCount = 0) {
            const isKoJa = ui.direction.value === 'ko-ja';
            const prompt = isKoJa ?
                `You are a senior Japanese B2B proposal slide localizer.

Task:
Translate the following Korean business proposal slide strings into persuasive, presentation-ready Japanese suitable for a corporate solution proposal.

Context:
This is NOT UI text or a manual.
This content is for slide-based sales/proposal materials targeting decision-makers.

Rules:
1. Maintain the exact same array length: ${texts.length}.
2. Return ONLY a valid JSON array of strings.
3. Use concise, slide-optimized Japanese.
4. Prioritize clarity, impact, and business value.
5. Prefer noun-ending structures (ä½“è¨€æ­¢ã‚) where appropriate.
6. Avoid UI-style phrasing such as:
   - ã€Œã€œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€
   - ã€Œã€œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€
7. Avoid unnecessary polite Desu/Masu forms unless grammatically required.
8. Do not exaggerate (avoid words like çˆ†å¢—, å®Œç’§).
9. Preserve headings, bullet rhythm, and logical structure.
10. Keep product names and technical brand terms in English.
11. Remove any internal comments or irrelevant notes.

Translation Style Guidelines:
- Make the text feel like a Japanese executive presentation slide.
- Reduce verbosity.
- Convert explanatory sentences into impact-driven phrases where possible.
- Emphasize differentiation, efficiency, value, and outcomes.

Input: ${JSON.stringify(texts)}` :
                `You are a senior Korean B2B proposal slide localizer.

Task:
Translate the following Japanese business proposal slide strings into persuasive, presentation-ready Korean suitable for a corporate solution proposal.

Context:
This is NOT UI text or a manual.
This content is for slide-based sales/proposal materials targeting decision-makers.

Rules:
1. Maintain the exact same array length: ${texts.length}.
2. Return ONLY a valid JSON array of strings.
3. Use concise, slide-optimized Korean.
4. Prioritize clarity, impact, and business value.
5. Prefer noun-ending structures (ì²´ì–¸ì¢…ê²°) where appropriate.
6. Avoid verbose or UI-style phrasing such as:
   - ã€Œï½í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤ã€
   - ã€Œï½ì„/ë¥¼ ì œê³µí•©ë‹ˆë‹¤ã€(when a more impactful phrase is available)
7. Avoid unnecessary sentence-final endings unless grammatically required.
8. Do not exaggerate (avoid words like í­ë°œì , ì™„ë²½í•œ).
9. Preserve headings, bullet rhythm, and logical structure.
10. Keep product names and technical brand terms in English.
11. Remove any internal comments or irrelevant notes.

Translation Style Guidelines:
- Make the text feel like a Korean executive presentation slide.
- Reduce verbosity.
- Convert explanatory sentences into impact-driven phrases where possible.
- Emphasize differentiation, efficiency, value, and outcomes.

Input: ${JSON.stringify(texts)}`;

            const keys = keysRaw.split(/[\n,]/).map(k => k.trim()).filter(k => k !== "");
            if (!keys.length) throw new Error("API Key Missing");

            for (const key of keys) {
                const models = await getModels(key);
                for (const model of models) {
                    try {
                        const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                generationConfig: { temperature: 0.1, responseMimeType: "application/json" },
                                safetySettings: [
                                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                                ]
                            })
                        });
                        if (!r.ok) continue;
                        const res = await r.json();
                        if (!res.candidates || !res.candidates[0].content) continue;
                        let text = res.candidates[0].content.parts[0].text.replace(/^```json\s*|\s*```$/gi, "");
                        const parsed = JSON.parse(text);
                        if (Array.isArray(parsed) && parsed.length === texts.length) return parsed;
                        else continue;
                    } catch (e) { continue; }
                }
            }

            if (retryCount < 2) {
                log(`[Retry] Batch failed, retrying... (${retryCount + 1}/2)`);
                await new Promise(r => setTimeout(r, 2000));
                return await translateBatch(texts, keysRaw, retryCount + 1);
            }
            throw new Error("All Gemini API attempts and retries failed.");
        }

        function applyMeiryo(p, conf) {
            let prs = Array.from(p.getElementsByTagNameNS(conf.ns, conf.rPrTag));
            if (conf.isWord) {
                Array.from(p.getElementsByTagNameNS(conf.ns, "pPr")).forEach(pp => {
                    let rpr = pp.getElementsByTagNameNS(conf.ns, "rPr")[0];
                    if (rpr && !prs.includes(rpr)) prs.push(rpr);
                });
            }
            prs.forEach(pr => {
                if (conf.isWord) {
                    let f = pr.getElementsByTagNameNS(conf.ns, "rFonts")[0];
                    if (!f) { f = pr.ownerDocument.createElementNS(conf.ns, "w:rFonts"); pr.prepend(f); }
                    f.setAttribute("w:ascii", "Meiryo"); f.setAttribute("w:hAnsi", "Meiryo"); f.setAttribute("w:eastAsia", "Meiryo"); f.setAttribute("w:cs", "Meiryo"); f.setAttribute("w:hint", "eastAsia");
                } else {
                    ["latin", "ea", "cs"].forEach(t => {
                        let n = pr.getElementsByTagNameNS(conf.ns, t)[0];
                        if (!n) { n = pr.ownerDocument.createElementNS(conf.ns, "a:" + t); pr.appendChild(n); }
                        n.setAttribute("typeface", "Meiryo");
                    });
                }
            });
        }

        async function processXml(zip, fileName, keys, type, isStyleOnly) {
            const conf = CONFIG[type];
            const xml = await zip.file(fileName).async("string");
            const doc = new DOMParser().parseFromString(xml, "application/xml");
            const paragraphs = Array.from(doc.getElementsByTagNameNS(conf.ns, conf.pTag));
            if (type === 'pptx' && !isStyleOnly) {
                const slideNum = fileName.match(/slide(\d+)\.xml/)?.[1];
                if (slideNum && selectedImages[slideNum]) {
                    const pics = Array.from(doc.getElementsByTagName("p:pic"));
                    pics.forEach(pic => {
                        const blip = pic.getElementsByTagName("a:blip")[0];
                        if (blip) {
                            const rId = blip.getAttribute("r:embed");
                            if (selectedImages[slideNum][rId]) {
                                let spPr = pic.getElementsByTagName("p:spPr")[0];
                                if (spPr) {
                                    let effectLst = spPr.getElementsByTagName("a:effectLst")[0] || doc.createElementNS("http://schemas.openxmlformats.org/drawingml/2006/main", "a:effectLst");
                                    spPr.appendChild(effectLst);
                                    Array.from(effectLst.getElementsByTagName("a:glow")).forEach(g => g.remove());
                                    const glow = doc.createElementNS("http://schemas.openxmlformats.org/drawingml/2006/main", "a:glow");
                                    glow.setAttribute("rad", "280000");
                                    const srgbClr = doc.createElementNS("http://schemas.openxmlformats.org/drawingml/2006/main", "a:srgbClr");
                                    srgbClr.setAttribute("val", "FF0000");
                                    const alpha = doc.createElementNS("http://schemas.openxmlformats.org/drawingml/2006/main", "a:alpha");
                                    alpha.setAttribute("val", "75000");
                                    srgbClr.appendChild(alpha); glow.appendChild(srgbClr); effectLst.appendChild(glow);
                                }
                            }
                        }
                    });
                }
            }
            if (isStyleOnly) paragraphs.forEach(p => applyMeiryo(p, conf));
            else {
                const batch = []; const targets = [];
                paragraphs.forEach(p => {
                    const ts = Array.from(p.getElementsByTagNameNS(conf.ns, "t"));
                    if (!ts.length) return;
                    const fullText = ts.map(t => t.textContent).join("");
                    if (!fullText.trim() || /^[\d\s,.\-%]+$/.test(fullText.trim())) return;
                    batch.push(fullText); targets.push({ p, ts });
                });
                if (batch.length > 0) {
                    const size = 15;
                    for (let i = 0; i < batch.length; i += size) {
                        try {
                            const results = await translateBatch(batch.slice(i, i + size), keys);
                            results.forEach((translated, j) => {
                                const target = targets[i + j];
                                if (target) {
                                    target.ts[0].textContent = translated;
                                    for (let k = 1; k < target.ts.length; k++) target.ts[k].textContent = "";
                                    if (ui.direction.value === 'ko-ja') applyMeiryo(target.p, conf);
                                }
                            });
                        } catch (e) { log(`[Warn] Batch failed: ${fileName}`); }
                    }
                }
            }
            zip.file(fileName, new XMLSerializer().serializeToString(doc));
        }

        ui.mainBtn.addEventListener('click', async () => {
            const file = ui.fileInput.files[0];
            const keys = ui.apiKey.value.trim();
            if (!file) return;
            if (currentMode === 'ai' && !keys) return;
            const ext = file.name.split('.').pop().toLowerCase();
            ui.mainBtn.disabled = true; log(t.log_start, true); setProgress(5);
            try {
                const zip = await JSZip.loadAsync(file);
                const targets = CONFIG[ext].getFiles(zip);
                for (let i = 0; i < targets.length; i++) {
                    log(`${i + 1}/${targets.length}...`);
                    await processXml(zip, targets[i], keys, ext, currentMode === 'style');
                    setProgress(10 + ((i + 1) / targets.length) * 80);
                }
                const blob = await zip.generateAsync({ type: "blob", compression: "DEFLATE", compressionOptions: { level: 9 } });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `${currentMode}_${file.name}`; a.click();
                log(`Done! ${(blob.size / 1024 / 1024).toFixed(2)} MB`); setProgress(100);
            } catch (e) { log(`Error: ${e.message}`); } finally { ui.mainBtn.disabled = false; }
        });

        initLang();
    </script>
</body>

</html>